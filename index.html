<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Learning Platform</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f1f5f9;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .login-container {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #f1f5f9;
    }
    .login-box {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 400px;
    }
    .login-box h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    .login-box input {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .login-box input:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    .login-box button {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .login-box button.primary {
      background-color: #3b82f6;
      color: white;
    }
    .login-box button.primary:hover {
      background-color: #2563eb;
    }
    .login-box button.secondary {
      background: none;
      color: #3b82f6;
    }
    .login-box button.secondary:hover {
      text-decoration: underline;
    }
    .course-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
    }
    .course-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      cursor: pointer;
    }
    .course-card:hover {
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }
    .course-page {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 250px;
      background: white;
      padding: 20px;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
    }
    .sidebar h3 {
      margin-top: 0;
    }
    .sidebar button {
      display: block;
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: none;
      border-radius: 4px;
      text-align: left;
      cursor: pointer;
    }
    .sidebar button.active {
      background-color: #3b82f6;
      color: white;
    }
    .sidebar button:hover:not(.active) {
      background-color: #e5e7eb;
    }
    .sidebar button.back {
      background-color: #6b7280;
      color: white;
    }
    .sidebar button.back:hover {
      background-color: #4b5563;
    }
    .content {
      flex: 1;
      padding: 20px;
    }
    .video-container video {
      width: 100%;
      max-width: 800px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .like-section {
      margin: 20px 0;
    }
    .like-section button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 20px;
      margin-right: 10px;
    }
    .like-section button.liked {
      color: #ef4444;
    }
    .comments-section {
      margin-top: 20px;
    }
    .comment {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .comment p {
      margin: 0;
    }
    .comment .timestamp {
      font-size: 0.9em;
      color: #6b7280;
    }
    .comments-section textarea {
      width: 100%;
      padding: 10px;
      margin: 10px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .comments-section textarea:focus {
      outline: none;
      border-color: #3b82f6;
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }
    .comments-section button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      background-color: #3b82f6;
      color: white;
      cursor: pointer;
    }
    .comments-section button:hover {
      background-color: #2563eb;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script>
    // State management
    let state = {
      user: null,
      token: null,
      courses: [],
      selectedCourse: null,
      currentLesson: null,
      likes: {},
      comments: {},
      isRegistering: false
    };

    const API_URL = 'https://quqyqbackend.onrender.com';

    async function fetchWithAuth(url, options = {}) {
      const token = localStorage.getItem('token');
      options.headers = {
        ...options.headers,
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      };
      const response = await fetch(url, options);
      if (response.status === 401) {
        state.user = null;
        state.token = null;
        localStorage.removeItem('token');
        render();
        throw new Error('Unauthorized');
      }
      return response;
    }

    function render() {
      const root = document.getElementById('root');
      root.innerHTML = '';
      if (!state.user) {
        renderLogin();
      } else if (!state.selectedCourse) {
        renderCourseSelection();
      } else {
        renderCoursePage();
      }
    }

    function renderLogin() {
      const root = document.getElementById('root');
      root.innerHTML = `
        <div class="login-container">
          <div class="login-box">
            <h2>${state.isRegistering ? 'Register' : 'Login'}</h2>
            <input type="email" id="email" placeholder="Email">
            <input type="password" id="password" placeholder="Password">
            <button class="primary" onclick="handleLogin()">${state.isRegistering ? 'Register' : 'Login'}</button>
            <button class="secondary" onclick="toggleRegister()">${state.isRegistering ? 'Already have an account? Login' : 'Need an account? Register'}</button>
          </div>
        </div>
      `;
    }

    async function handleLogin() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      if (email && password) {
        try {
          const endpoint = state.isRegistering ? '/auth/register' : '/auth/token';
          const body = state.isRegistering
            ? JSON.stringify({ email, password })
            : `username=${encodeURIComponent(email)}&password=${encodeURIComponent(password)}`;
          const response = await fetch(`${API_URL}${endpoint}`, {
            method: 'POST',
            headers: {
              'Content-Type': state.isRegistering ? 'application/json' : 'application/x-www-form-urlencoded'
            },
            body
          });
          if (!response.ok) throw new Error('Authentication failed');
          const data = await response.json();
          state.user = { email };
          state.token = data.access_token;
          localStorage.setItem('token', data.access_token);
          await fetchCourses();
          render();
        } catch (error) {
          alert('Error: ' + error.message);
        }
      }
    }

    function toggleRegister() {
      state.isRegistering = !state.isRegistering;
      render();
    }

    async function fetchCourses() {
      try {
        const response = await fetchWithAuth(`${API_URL}/courses/`);
        state.courses = await response.json();
      } catch (error) {
        console.error('Error fetching courses:', error);
      }
    }

async function renderCourseSelection() {
  await fetchCourses(); // Ensure latest data
  const root = document.getElementById('root');
  root.innerHTML = `
    <div class="container">
      <h2 style="text-align: center; font-size: 1.875rem; font-weight: bold; margin-bottom: 1.5rem;">Available Courses</h2>
      <div class="course-grid">
        ${state.courses.map(course => `
          <div class="course-card" onclick="selectCourse(${course.id})">
            <h3 style="font-size: 1.25rem; font-weight: 600;">${course.title}</h3>
            <p style="color: #6b7280;">Click to start learning</p>
            <button onclick="dropCourse(${course.id})" style="background-color: #ef4444; color: white; padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px;">Drop</button>
          </div>
        `).join('')}
      </div>
    </div>
  `;
}

       async function dropCourse(courseId) {
         if (confirm(`Are you sure you want to delete course ${courseId}?`)) {
           try {
             await fetchWithAuth(`${API_URL}/courses/${courseId}`, {
               method: 'DELETE',
             });
             await fetchCourses(); // Refresh the course list
             render();
           } catch (error) {
             console.error('Error dropping course:', error);
             alert('Failed to delete course');
           }
         }
       }

async function selectCourse(courseId) {
  try {
    console.log(`Selecting course with ID: ${courseId}`); // Debug log
    const response = await fetchWithAuth(`${API_URL}/courses/${courseId}`);
    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
    state.selectedCourse = await response.json();
    state.currentLesson = state.selectedCourse.lessons[0];
    await fetchLikes(state.currentLesson.id);
    await fetchComments(state.currentLesson.id);
    render();
  } catch (error) {
    console.error('Error selecting course:', error);
    alert('Failed to load course: ' + error.message);
  }
}

       function embedYouTubeLink(text) {
         const youtubeRegex = /(https?:\/\/(?:www\.)?youtube\.com\/watch\?v=[\w-]{11}|https?:\/\/youtu\.be\/[\w-]{11})/g;
         return text.replace(youtubeRegex, (url) => {
           const videoId = url.includes("youtube.com") 
             ? url.split("v=")[1].split("&")[0]
             : url.split("/").pop();
           return `<iframe width="560" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
         });
       }

       async function renderCoursePage() {
         const course = state.selectedCourse;
         const lesson = state.currentLesson;
         const likes = state.likes[lesson.id] || { count: 0, isLiked: false };
         const comments = state.comments[lesson.id] || [];

         const root = document.getElementById('root');
         root.innerHTML = `
           <div class="course-page">
             <div class="sidebar">
               <h3>${course.title}</h3>
               ${course.lessons.map(l => `
                 <button class="${l.id === lesson.id ? 'active' : ''}" onclick="selectLesson(${l.id})">${l.title}</button>
               `).join('')}
               <button class="back" onclick="goBack()">Back to Courses</button>
             </div>
             <div class="content">
               <div class="video-container">
                  <video controls src="${lesson.video_url}">
                  </video>
               </div>
               <h2 style="font-size: 1.5rem; font-weight: bold; margin-top: 1rem;">${lesson.title}</h2>
               <p style="color: #6b7280; margin-top: 0.5rem;">${lesson.transcript}</p>
               <div class="like-section">
                 <button class="${likes.isLiked ? 'liked' : ''}" onclick="handleLike(${lesson.id})">❤️</button>
                 <span>${likes.count} ${likes.count === 1 ? 'Like' : 'Likes'}</span>
               </div>
               <div class="comments-section">
                 <h3 style="font-size: 1.25rem; font-weight: 600;">Comments</h3>
                 <div>
                   ${comments.map(comment => `
                     <div class="comment">
                       ${embedYouTubeLink(comment.text).split('\n').map(line => `<p>${line}</p>`).join('')}
                       <p class="timestamp">${new Date(comment.timestamp).toLocaleString()}</p>
                     </div>
                   `).join('')}
                 </div>
                 <textarea id="new-comment" placeholder="Leave a comment..."></textarea>
                 <button onclick="postComment(${lesson.id})">Post Comment</button>
               </div>
             </div>
           </div>
         `;
       }

    async function selectLesson(lessonId) {
      state.currentLesson = state.selectedCourse.lessons.find(l => l.id === lessonId);
      await fetchLikes(lessonId);
      await fetchComments(lessonId);
      render();
    }

    async function fetchLikes(lessonId) {
      try {
        const response = await fetchWithAuth(`${API_URL}/likes/lesson/${lessonId}`);
        const likes = await response.json();
        const userLike = likes.find(like => like.user_id === state.user.id);
        state.likes[lessonId] = {
          count: likes.filter(like => like.is_liked).length,
          isLiked: userLike ? userLike.is_liked : false
        };
      } catch (error) {
        console.error('Error fetching likes:', error);
      }
    }

    async function handleLike(lessonId) {
      try {
        const isLiked = !state.likes[lessonId]?.isLiked;
        await fetchWithAuth(`${API_URL}/likes/`, {
          method: 'POST',
          body: JSON.stringify({ lesson_id: lessonId, is_liked: isLiked })
        });
        await fetchLikes(lessonId);
        render();
      } catch (error) {
        console.error('Error toggling like:', error);
      }
    }

    async function fetchComments(lessonId) {
      try {
        const response = await fetchWithAuth(`${API_URL}/comments/lesson/${lessonId}`);
        state.comments[lessonId] = await response.json();
      } catch (error) {
        console.error('Error fetching comments:', error);
      }
    }

    async function postComment(lessonId) {
      const commentText = document.getElementById('new-comment').value;
      if (commentText.trim()) {
        try {
          await fetchWithAuth(`${API_URL}/comments/`, {
            method: 'POST',
            body: JSON.stringify({ lesson_id: lessonId, text: commentText })
          });
          await fetchComments(lessonId);
          render();
        } catch (error) {
          console.error('Error posting comment:', error);
        }
      }
    }

    function goBack() {
      state.selectedCourse = null;
      state.currentLesson = null;
      render();
    }

    // Check for existing token
    const token = localStorage.getItem('token');
    if (token) {
      state.token = token;
      fetchCourses().then(() => render());
    } else {
      render();
    }
  </script>
</body>

</html>



